
Setup an experiment on Cloudlab using the SparkFHE-Dist-Ubuntu18.04 image. Use the Wisconsin server.

Please note that the scripts are designed to run on Master Node.

# SSH into Master Node
SSH into the master node and navigate to the address specified below:
```
cd /spark-3.0.0-SNAPSHOT-bin-SparkFHE/SparkFHE-Addon/scripts/cluster/yarn_cluster_setup
```

# Install Hadoop and Configure Spark on all nodes through Master Node
Specify the hostnames of nodes as arguments.
```
sudo bash install_yarn_cluster.sh master,worker1,worker2 ...
```

# Start Yarn Spark Cluster and Run Spark Job on Master
Cluster can only be started on master node after installation is complete on all nodes and configuration files for Yarn and Spark are placed in correct folders.
```
sudo bash start_yarn_cluster.sh
```

# Run Test Spark Job on Master
Use the link generated after successful completion of cluster building to view the web interface for Yarn.
```
cd test_scripts
sudo bash run_spark_test_job_pi.sh
```

## Web Interfaces:

The public IP addresses of all nodes have been closed to bolster security. To view the web Interface, some additional steps will have to be performed.

### Setup SSH Tunneling for nodes

Open a Terminal window on local machine and type the following:

```
ssh -4 -ND <PORT_NUMBER> <USERNAME@MASTER_NODE_ID.SERVER_AREA.cloudlab.us>
```
This step will bind the local machine's port to the IP address of Master Node.

### Get Internal IP of Master Node

On the master node run the following to get the internal IP of Master Node:
```
hostname -I | awk '{print $1}'
```
This same step can be done on any of the worker nodes.

### Configure Browser to open link

Open Mozilla Firefox browser in the local machine. 

Click on three horizontal bars available on the top right hand side.

Select Preferences and look for 'Network Settings' on the page.

Once inside Network Settings, Select Manual Proxy Configuration.

Select Socks_v5 and type in the Port Number chosen in the previous step for SOCKS Host. The IP of SOCKS Host does not need to be changed. Save the Settings.

### List of Web Interfaces

Other links can be generated by changing the port number.

#### YARN Interface:

http://<MASTER_NODE_IP_ADDRESS_INTERNAL>:8088/

The output of test job is available in the link above.  

Select the latest application, open the logs for that application, and select stdout. This should show the value for Pi calculated on the cluster.

#### Spark Interface:

http://<MASTER_NODE_IP_ADDRESS_INTERNAL>:8080/

#### Namenode Interface:

http://<MASTER_NODE_IP_ADDRESS_INTERNAL>:50070/

#### JobMaster Interface:

http://<MASTER_NODE_IP_ADDRESS_INTERNAL>:19888/

#### Datanode Interface:

http://<WORKER_NODE_IP_ADDRESS_INTERNAL>:50075/

### Remove Browser Configuration

To use the Mozilla Firefox browser regularly, Select 'No Proxy' in Network Settings and Save.

Stop the SSH tunneling by Closing the Terminal Window or Hit Ctrl + C in the terminal window.

# Stop the Cluster
```
cd ..
sudo bash stop_yarn_job.sh
```
After running this command, the web interfaces will not work.